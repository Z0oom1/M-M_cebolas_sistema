<header class="top-bar">
    <h2 class="page-title">Configurações e Segurança</h2>
</header>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

    <!-- CONFIGURAÇÕES DO SISTEMA -->
    <div class="panel">
        <div class="panel-header">
            <h4 style="font-weight: 700;"><i class="fas fa-cogs" style="color: var(--primary);"></i> Configurações do Sistema</h4>
        </div>
        <div style="padding: 24px; display: flex; flex-direction: column; gap: 20px;">

            <!-- Peso por Caixa -->
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 16px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 36px; height: 36px; background: #dcfce7; color: #166534; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-weight-hanging"></i>
                    </div>
                    <div>
                        <strong style="display: block;">Peso Padrão por Caixa</strong>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">Usado para calcular kg automaticamente ao registrar em caixas</span>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="number" id="config-peso-cx" placeholder="20" step="0.1" min="0.1"
                        style="flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem;">
                    <span style="background: #dbeafe; color: #1e40af; padding: 10px 14px; border-radius: 8px; font-weight: 700;">Kg/Cx</span>
                    <button class="btn-primary" onclick="savePesoPorCaixa()" style="padding: 10px 16px;">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
                <small style="color: var(--text-muted); margin-top: 8px; display: block;">
                    Exemplo: se cada caixa pesa 20 kg, ao registrar 10 caixas o sistema calculará 200 kg automaticamente.
                </small>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border);">

            <!-- Ambiente NF-e -->
            <div>
                <strong style="display: block; margin-bottom: 12px;">Ambiente NF-e</strong>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; padding: 14px; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: var(--transition);">
                        <input type="radio" name="nfe_modo" value="homologacao" onchange="updateNFeModo('homologacao')" style="width: auto; margin-top: 4px;">
                        <div>
                            <strong style="display: block; margin-bottom: 2px;">Homologação</strong>
                            <span style="color: var(--text-muted); font-size: 0.8rem;">Ambiente de testes. As notas não possuem valor fiscal.</span>
                        </div>
                    </label>
                    <label style="display: flex; align-items: flex-start; gap: 12px; padding: 14px; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: var(--transition);">
                        <input type="radio" name="nfe_modo" value="producao" onchange="updateNFeModo('producao')" style="width: auto; margin-top: 4px;">
                        <div>
                            <strong style="display: block; margin-bottom: 2px;">Produção</strong>
                            <span style="color: var(--text-muted); font-size: 0.8rem;">Ambiente real. As notas possuem validade jurídica e fiscal.</span>
                        </div>
                    </label>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border);">

            <!-- Certificado -->
            <div class="form-group">
                <label>Senha do Certificado (.pfx)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="password" id="cert-password" placeholder="Digite a senha do certificado" style="flex: 1;">
                    <button class="btn-primary" onclick="saveCertPassword()" style="padding: 10px 16px;">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <small style="color: var(--text-muted); margin-top: 4px;">O certificado deve estar em: <code>/server/certificado/certificado.pfx</code></small>
            </div>
        </div>
    </div>

    <div class="panel" id="admin-users-panel">
        <div class="panel-header">
            <h4 style="font-weight: 700;">Usuários e Acessos</h4>
            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openUsuarioModal()">
                <i class="fas fa-user-plus"></i> Novo Usuário
            </button>
        </div>
        <div class="table-container">
            <table class="table-compact">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Usuário</th>
                        <th>Nível</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody id="list-usuarios">
                    <!-- JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- LOGS DO SISTEMA (ADMIN APENAS) -->
<div id="admin-logs-panel" class="panel" style="margin-top: 24px;">
    <div class="panel-header">
        <h4 style="font-weight: 700;"><i class="fas fa-history"></i> Log de Atividades do Sistema</h4>
        <button class="btn-icon" onclick="loadLogs()"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>
    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
        <table class="table-compact">
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>Usuário</th>
                    <th>Ação</th>
                    <th>Detalhes</th>
                </tr>
            </thead>
            <tbody id="list-logs">
                <!-- JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- GESTÃO DE ENTIDADES (ADMIN APENAS) -->
<div id="admin-entities-panel" style="margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <div class="panel">
        <div class="panel-header">
            <h4 style="font-weight: 700;">Gerenciar Clientes</h4>
            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openEditModal('cliente')">
                <i class="fas fa-plus"></i> Novo Cliente
            </button>
        </div>
        <div class="table-container">
            <table class="table-compact">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody id="config-list-clientes"></tbody>
            </table>
        </div>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h4 style="font-weight: 700;">Gerenciar Fornecedores</h4>
            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openEditModal('fornecedor')">
                <i class="fas fa-plus"></i> Novo Fornecedor
            </button>
        </div>
        <div class="table-container">
            <table class="table-compact">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody id="config-list-fornecedores"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="admin-products-panel" class="panel" style="margin-top: 24px;">
    <div class="panel-header">
        <h4 style="font-weight: 700;">Gerenciar Produtos / Variedades</h4>
        <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openProdutoModal()">
            <i class="fas fa-plus"></i> Novo Produto
        </button>
    </div>
    <div class="table-container">
        <table class="table-compact">
            <thead>
                <tr>
                    <th>Variedade</th>
                    <th>NCM</th>
                    <th>Preço Base</th>
                    <th>Kg/Cx</th>
                    <th style="text-align: right;">Ações</th>
                </tr>
            </thead>
            <tbody id="config-list-produtos"></tbody>
        </table>
    </div>
</div>

<div id="admin-danger-panel" class="panel" style="margin-top: 24px; border: 2px solid #fee2e2;">
    <div class="panel-header" style="background: #fff1f2; border-bottom: 1px solid #fee2e2;">
        <h4 style="color: #991b1b; font-weight: 800;"><i class="fas fa-exclamation-triangle"></i> ZONA DE PERIGO (ADMINISTRADOR)</h4>
    </div>
    <div style="padding: 24px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <strong style="display: block; margin-bottom: 4px; color: #991b1b; font-size: 1.1rem;">Resetar Dados do Sistema</strong>
            <span style="color: var(--text-muted); font-size: 0.9rem;">Esta ação é irreversível. Apagará movimentações, NF-es, clientes, fornecedores e produtos.</span>
        </div>
        <button class="btn-danger" onclick="resetSystem()" style="background: #dc2626; padding: 14px 28px; font-weight: 800; border-radius: 10px; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);">
            <i class="fas fa-trash-alt"></i> APAGAR TUDO E REINICIAR
        </button>
    </div>
</div>

<!-- Modal de Usuário/Funcionário -->
<div id="modal-usuario" class="modal-overlay">
    <div class="edit-modal" style="max-width: 500px;">
        <div class="panel-header" style="background: #2563eb; color: white; padding: 20px;">
            <h3 id="user-modal-title" style="margin: 0;">Gestão de Acesso</h3>
            <button onclick="closeUsuarioModal()" style="background:none; border:none; font-size:1.8rem; cursor:pointer; color: white;">&times;</button>
        </div>
        <form onsubmit="saveUsuario(event)" class="form-grid" style="grid-template-columns: 1fr;">
            <input type="hidden" id="user-id">
            <div class="form-group">
                <label>Nome Completo (Exibição)</label>
                <input type="text" id="user-label" required placeholder="Ex: João da Silva">
            </div>
            <div class="form-group">
                <label>Nome de Usuário (Login)</label>
                <input type="text" id="user-username" required placeholder="Ex: joao.silva">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="user-password" placeholder="Deixe em branco para manter a atual">
            </div>
            <div class="form-group">
                <label>Nível de Acesso</label>
                <select id="user-role">
                    <option value="funcionario">Funcionário (Operacional)</option>
                    <option value="chefe">Chefe (Acesso Total)</option>
                    <option value="admin">Administrador (Gestão de Sistema)</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 10px;">
                <button type="button" class="btn-danger" onclick="closeUsuarioModal()" style="flex: 1;">Cancelar</button>
                <button type="submit" class="btn-primary" style="flex: 2; background: #2563eb;">Salvar Acesso</button>
            </div>
        </form>
    </div>
</div>

<style>
    label:has(input:checked) {
        border-color: var(--primary) !important;
        background: #f0fdf4 !important;
    }
</style>
